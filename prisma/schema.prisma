// This is your Prisma schema file for WheelWise
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User model with authentication
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  tokens        Int       @default(1000) // Virtual tokens for gambling
  totalSpins    Int       @default(0)
  totalWins     Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts         Account[]
  sessions         Session[]
  wheels           Wheel[]
  spins            Spin[]
  hostedRooms      Room[]
  roomParticipants RoomParticipant[]
  messages         Message[]
  wheelMembers     WheelMember[]
  tokenHistory     TokenTransaction[]

  @@index([email])
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Wheel configuration
model Wheel {
  id          String   @id @default(cuid())
  title       String?
  description String?
  userId      String?
  isPublic    Boolean  @default(false)  // Private by default
  isActive    Boolean  @default(true)
  roomId      String?  // Wheel created in a room
  
  // Customization
  theme       Json?    // {background, colors, font, sounds}
  logoUrl     String?
  
  // Statistics
  totalSpins  Int      @default(0)
  viewCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  options     WheelOption[]
  spins       Spin[]
  members     WheelMember[]
  room        Room?         @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isPublic])
  @@index([createdAt])
}

// Wheel options/slices
model WheelOption {
  id       String @id @default(cuid())
  wheelId  String
  label    String
  weight   Int    @default(1) // For weighted spins
  color    String @default("#3b82f6")
  imageUrl String?
  order    Int    @default(0)
  isActive Boolean @default(true)

  wheel Wheel  @relation(fields: [wheelId], references: [id], onDelete: Cascade)
  spins Spin[]

  @@index([wheelId])
}

// Collaborative wheel access
model WheelMember {
  id        String   @id @default(cuid())
  wheelId   String
  userId    String
  role      MemberRole @default(VIEWER)
  joinedAt  DateTime @default(now())

  wheel Wheel @relation(fields: [wheelId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([wheelId, userId])
  @@index([userId])
}

// Spin records with provably fair data
model Spin {
  id              String   @id @default(cuid())
  wheelId         String
  userId          String?
  roomId          String?
  optionId        String
  
  // Provably Fair System
  serverSeed      String   // Server-generated seed
  clientSeed      String   // Client-generated seed
  nonce           Int      // Incremental counter
  combinedHash    String   // SHA-256 hash for verification
  resultValue     Float    // 0-1 normalized result
  
  // Metadata
  betAmount       Int?     // Tokens bet (if gambling)
  winAmount       Int?     // Tokens won
  isWinner        Boolean  @default(false)
  
  // Sharing
  shareId         String   @unique @default(cuid())
  shareUrl        String?
  resultCardUrl   String?
  
  createdAt       DateTime @default(now())

  // Relations
  wheel  Wheel        @relation(fields: [wheelId], references: [id], onDelete: Cascade)
  user   User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  room   Room?        @relation(fields: [roomId], references: [id], onDelete: SetNull)
  option WheelOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@index([wheelId])
  @@index([userId])
  @@index([roomId])
  @@index([shareId])
  @@index([createdAt])
}

// Live spin rooms
model Room {
  id            String   @id @default(cuid())
  code          String   @unique // 6-character join code
  name          String?
  description   String?
  hostId        String
  isActive      Boolean  @default(true)
  isPublic      Boolean  @default(false)
  maxMembers    Int      @default(50)
  
  // Room settings
  allowGuestJoin    Boolean @default(true)
  allowParticipantSpin Boolean @default(true)
  allowParticipantEdit Boolean @default(false)
  enableChat        Boolean @default(true)
  enableVoiceChat   Boolean @default(false)
  
  // Current wheel state for real-time sync
  currentWheelState Json? // Active wheel options, spinning state, etc.
  
  createdAt   DateTime @default(now())
  closedAt    DateTime?
  lastActivity DateTime @default(now())

  // Relations
  host         User            @relation(fields: [hostId], references: [id], onDelete: Cascade)
  participants RoomParticipant[]
  wheels       Wheel[]         // Multiple wheels can be created in a room
  spins        Spin[]
  messages     Message[]

  @@index([code])
  @@index([hostId])
  @@index([isActive])
  @@index([isPublic])
}

// Room participants for real-time collaboration
model RoomParticipant {
  id          String   @id @default(cuid())
  roomId      String
  userId      String?  // Null for guest users
  guestName   String?  // Name for guest users
  role        RoomRole @default(PARTICIPANT)
  isOnline    Boolean  @default(true)
  lastSeen    DateTime @default(now())
  joinedAt    DateTime @default(now())
  
  // Permissions
  canSpin     Boolean  @default(true)
  canEditWheel Boolean @default(false)
  canManageRoom Boolean @default(false)

  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([roomId, userId]) // Prevent duplicate user entries
  @@index([roomId])
  @@index([userId])
}

// Real-time chat
model Message {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  content   String
  type      MessageType @default(CHAT)
  
  createdAt DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([createdAt])
}

// Token transaction history
model TokenTransaction {
  id        String   @id @default(cuid())
  userId    String
  amount    Int      // Positive for gains, negative for losses
  type      TokenType
  spinId    String?
  reason    String?
  
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// Enums
enum MemberRole {
  OWNER
  EDITOR
  VIEWER
}

enum RoomRole {
  HOST
  MODERATOR
  PARTICIPANT
  VIEWER
}

enum MessageType {
  CHAT
  SYSTEM
  SPIN_RESULT
  USER_JOINED
  USER_LEFT
  WHEEL_CREATED
  SPIN_COMPLETED
}

enum TokenType {
  DAILY_BONUS
  SPIN_WIN
  SPIN_LOSS
  PURCHASE
  GIFT
}
